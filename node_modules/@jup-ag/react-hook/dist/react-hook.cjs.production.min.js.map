{"version":3,"file":"react-hook.cjs.production.min.js","sources":["../src/error.tsx","../src/index.tsx","../src/utils/useDebounce.ts"],"sourcesContent":["export const Errors = {\n  INITIALIZE_ERROR: 'INITIALIZE_ERROR' as 'INITIALIZE_ERROR',\n  ROUTES_ERROR: 'ROUTES_ERROR' as 'ROUTES_ERROR',\n};\n","import React, { useEffect, useState, useMemo, useCallback, useRef, createContext, useContext } from 'react';\nimport { Connection, PublicKey } from '@solana/web3.js';\nimport { Errors } from './error';\nimport useDebounce from './utils/useDebounce';\nimport {\n  RouteInfo,\n  Jupiter,\n  SwapResult,\n  TOKEN_LIST_URL,\n  MARKETS_URL,\n  JUPITER_ERRORS,\n  JupiterLoadParams,\n  SwapMode,\n  INDEXED_ROUTE_MAP_URL,\n} from '@jup-ag/core';\nimport JSBI from 'jsbi';\n\nexport type JupiterError = typeof Errors[keyof typeof Errors];\n\ninterface UseJupiterResult {\n  /** routes that are possible, sorted decending based on outAmount */\n  routes?: RouteInfo[];\n  /** exchange function to submit transaction */\n  exchange: (\n    params: Parameters<Jupiter['exchange']>[0] & Parameters<Awaited<ReturnType<Jupiter['exchange']>>['execute']>[0],\n  ) => Promise<SwapResult>;\n  /** refresh function to refetch the prices */\n  refresh: () => void;\n  /** last refresh timestamp */\n  lastRefreshTimestamp: number;\n  /** all possible token mints to be chosen from */\n  allTokenMints: string[];\n  /** route map input mint with output mints */\n  routeMap: Map<string, string[]>;\n  /** loading state */\n  loading: boolean;\n  error: JupiterError | undefined;\n}\n\ninterface JupiterProps extends Omit<JupiterLoadParams, 'user'> {\n  onlyDirectRoutes?: boolean;\n  userPublicKey?: PublicKey;\n  routeCacheDuration?: number;\n  children?: React.ReactNode;\n  enforceSingleTx?: boolean;\n}\n\nconst JupiterContext = createContext<\n  | (Pick<UseJupiterResult, 'allTokenMints' | 'routeMap'> & {\n      connection: Connection;\n      cluster: string;\n      jupiter: Jupiter | undefined;\n      error: JupiterError | undefined;\n      setError: (error?: JupiterError) => void;\n      routeCacheDuration?: number;\n      onlyDirectRoutes?: boolean;\n    })\n  | null\n>(null);\n\nexport const JupiterProvider: React.FC<JupiterProps> = ({\n  onlyDirectRoutes,\n  userPublicKey,\n  children,\n  ...jupiterLoadProps\n}) => {\n  const [jupiter, setJupiter] = useState<Jupiter>();\n  const [routeMap, setRouteMap] = useState(new Map<string, string[]>());\n  const [error, setError] = useState<JupiterError>();\n\n  useEffect(() => {\n    (async () => {\n      try {\n        setError(undefined);\n        const _jupiter = await Jupiter.load({\n          ...jupiterLoadProps,\n        });\n\n        setJupiter(_jupiter);\n      } catch (e) {\n        console.error(e);\n        setError(Errors.INITIALIZE_ERROR);\n        throw e;\n      }\n    })();\n  }, Object.values(jupiterLoadProps));\n\n  useEffect(() => {\n    if (jupiter && userPublicKey) {\n      jupiter.setUserPublicKey(userPublicKey);\n    }\n  }, [jupiter, userPublicKey]);\n\n  useEffect(() => {\n    async function update() {\n      let routeMap = new Map<string, string[]>();\n\n      // so that we follow the marketUrl host name and get preprod and prod\n      let _url = new URL(INDEXED_ROUTE_MAP_URL);\n      if (jupiterLoadProps.marketUrl) {\n        _url.hostname = new URL(jupiterLoadProps.marketUrl).hostname;\n      }\n\n      let url = _url.toString();\n\n      routeMap = await Jupiter.getRemoteRouteMap(\n        { onlyDirectRoutes, restrictIntermediateTokens: jupiterLoadProps.restrictIntermediateTokens },\n        url,\n      );\n\n      setRouteMap(routeMap);\n    }\n    update();\n  }, [jupiterLoadProps.restrictIntermediateTokens, onlyDirectRoutes]);\n\n  const allTokenMints = useMemo(() => {\n    return Array.from(routeMap.keys());\n  }, [routeMap]);\n\n  return (\n    <JupiterContext.Provider\n      value={{\n        jupiter,\n        allTokenMints,\n        connection: jupiterLoadProps.connection,\n        cluster: jupiterLoadProps.cluster,\n        routeCacheDuration: jupiterLoadProps.routeCacheDuration,\n        routeMap,\n        error,\n        setError,\n        onlyDirectRoutes,\n      }}\n    >\n      {children}\n    </JupiterContext.Provider>\n  );\n};\n\ninterface UseJupiterProps {\n  amount: JSBI;\n  inputMint: PublicKey | undefined;\n  outputMint: PublicKey | undefined;\n  slippage: number;\n  /* inputAmount is being debounced, debounceTime 0 to disable debounce */\n  debounceTime?: number;\n  swapMode?: SwapMode;\n  enforceSingleTx?: boolean;\n}\n\nexport const useJupiterRouteMap = () => {\n  const context = useContext(JupiterContext);\n  if (!context) {\n    throw new Error('JupiterProvider is required');\n  }\n  return context.routeMap;\n};\n\nexport const useJupiter = ({\n  amount,\n  inputMint,\n  outputMint,\n  slippage,\n  debounceTime = 250,\n  swapMode = SwapMode.ExactIn,\n  enforceSingleTx,\n}: UseJupiterProps): UseJupiterResult => {\n  const context = useContext(JupiterContext);\n  const [loading, setLoading] = useState(false);\n  const [routes, setRoutes] = useState<RouteInfo[]>();\n  const [refreshCount, setRefreshCount] = useState<number>(0);\n  // lastRefreshCount indicate when the last refresh was triggered on which refreshCount\n  const lastRefreshCount = useRef<number>(refreshCount);\n\n  const [debouncedAmount, debouncedInputMint, debouncedOutputMint] = useDebounce(\n    React.useMemo(\n      () => [amount, inputMint, outputMint],\n      [amount.toString(), inputMint?.toBase58(), outputMint?.toBase58()],\n    ),\n    debounceTime,\n  );\n\n  const lastRefreshTimestamp = useRef<number>(0);\n  const lastQueryTimestamp = useRef<number>(0);\n\n  if (!context) {\n    throw new Error('JupiterProvider is required');\n  }\n\n  const { routeMap, allTokenMints, jupiter, error, setError, routeCacheDuration = 0, onlyDirectRoutes } = context;\n\n  // lastRefreshCount to determine when the last refresh was triggered, reset this to -1 to trigger a re-fetch\n  useEffect(() => {\n    lastRefreshCount.current = -1;\n  }, [[debouncedInputMint?.toString(), debouncedOutputMint?.toString()].sort().join('-'), slippage]);\n\n  useEffect(() => {\n    // if now - lastRefreshTimestamp > routeCacheDuration, then we need to refresh\n    if (lastRefreshTimestamp.current && new Date().getTime() - lastRefreshTimestamp.current >= routeCacheDuration) {\n      lastRefreshCount.current = -1;\n    }\n\n    if (JSBI.greaterThan(debouncedAmount, JSBI.BigInt(0)) && refreshCount !== lastRefreshCount.current) {\n      // don't set loading if there is no input amount\n      setLoading(true);\n    }\n  }, [refreshCount, debouncedAmount, slippage, debouncedInputMint, debouncedOutputMint, onlyDirectRoutes]);\n\n  useEffect(() => {\n    if (!jupiter) {\n      return;\n    }\n\n    if (JSBI.equal(debouncedAmount, JSBI.BigInt(0)) || error === Errors.INITIALIZE_ERROR) {\n      setRoutes(undefined);\n    } else if (debouncedAmount) {\n      if (!debouncedInputMint || !debouncedOutputMint || !routeMap) return;\n      let lastUpdatedTime = new Date().getTime();\n      lastQueryTimestamp.current = lastUpdatedTime;\n\n      jupiter\n        .computeRoutes({\n          inputMint: debouncedInputMint,\n          outputMint: debouncedOutputMint,\n          amount: debouncedAmount,\n          slippageBps: Math.ceil(slippage * 100),\n          forceFetch: refreshCount !== lastRefreshCount.current,\n          onlyDirectRoutes,\n          swapMode,\n          enforceSingleTx,\n        })\n        .then(({ routesInfos, cached }) => {\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          setRoutes(routesInfos);\n          setError(undefined);\n\n          if (!cached) {\n            lastRefreshTimestamp.current = new Date().getTime();\n          }\n        })\n        .catch((e) => {\n          console.error(e);\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          // Clear routes when erring to avoid bad pricing\n          setRoutes(undefined);\n          setError(Errors.ROUTES_ERROR);\n        })\n        .finally(() => {\n          if (lastQueryTimestamp.current !== lastUpdatedTime) {\n            return;\n          }\n          lastRefreshCount.current = refreshCount;\n          setLoading(false);\n        });\n    }\n  }, [\n    jupiter,\n    debouncedAmount,\n    debouncedInputMint,\n    debouncedOutputMint,\n    slippage,\n    refreshCount,\n    onlyDirectRoutes,\n    enforceSingleTx,\n  ]);\n\n  const exchange: UseJupiterResult['exchange'] = useCallback(\n    async ({ wallet, routeInfo, onTransaction, ...restExchangeProps }): Promise<SwapResult> => {\n      if (error) {\n        throw new Error(error);\n      }\n\n      if (!jupiter) {\n        throw new Error('Jupiter not initialized');\n      }\n\n      if (!routeInfo) {\n        throw new Error('Invalid state, impossible to build transaction');\n      }\n\n      const { execute } = await jupiter.exchange({ routeInfo, ...restExchangeProps });\n\n      const result = await execute({ wallet, onTransaction });\n\n      return result;\n    },\n    [jupiter],\n  );\n\n  return {\n    allTokenMints,\n    routeMap,\n    exchange,\n    refresh: () => {\n      if (!loading && lastRefreshTimestamp.current) {\n        setRefreshCount((refreshCount) => refreshCount + 1);\n      }\n    },\n    lastRefreshTimestamp: lastRefreshTimestamp.current,\n    loading,\n    routes,\n    error,\n  };\n};\n\nexport { TOKEN_LIST_URL, JUPITER_ERRORS, MARKETS_URL, Errors };\nexport * from '@jup-ag/core';\n","import { useEffect, useState } from 'react';\n\nexport default function useDebounce<T>(value: T, delay: number): T {\n  const [debouncedValue, setDebouncedValue] = useState(value);\n  useEffect(\n    () => {\n      // Update debounced value after delay\n      const handler = setTimeout(() => {\n        setDebouncedValue(value);\n      }, delay);\n      // Cancel the timeout if value changes (also on delay change or unmount)\n      return () => {\n        clearTimeout(handler);\n      };\n    },\n    [value, delay], // Only re-call effect if value or delay changes\n  );\n  return debouncedValue;\n}\n"],"names":["Errors","INITIALIZE_ERROR","ROUTES_ERROR","JupiterContext","createContext","onlyDirectRoutes","userPublicKey","children","jupiterLoadProps","jupiter","setJupiter","useState","routeMap","setRouteMap","Map","error","setError","useEffect","undefined","_jupiter","Jupiter","load","e","console","Object","values","setUserPublicKey","async","let","_url","URL","INDEXED_ROUTE_MAP_URL","marketUrl","hostname","url","toString","getRemoteRouteMap","restrictIntermediateTokens","allTokenMints","useMemo","Array","from","keys","React","createElement","Provider","value","connection","cluster","routeCacheDuration","amount","inputMint","outputMint","slippage","debounceTime","swapMode","SwapMode","ExactIn","enforceSingleTx","context","useContext","loading","setLoading","routes","setRoutes","refreshCount","setRefreshCount","lastRefreshCount","useRef","debouncedAmount","debouncedInputMint","debouncedOutputMint","delay","debouncedValue","setDebouncedValue","handler","setTimeout","clearTimeout","default","toBase58","lastRefreshTimestamp","lastQueryTimestamp","Error","current","sort","join","Date","getTime","JSBI","greaterThan","BigInt","equal","lastUpdatedTime","computeRoutes","slippageBps","Math","ceil","forceFetch","then","routesInfos","cached","catch","finally","exchange","useCallback","wallet","routeInfo","onTransaction","restExchangeProps","execute","refresh"],"mappings":"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"}